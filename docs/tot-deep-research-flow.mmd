flowchart TB
  UQ([User Query])
  SQ0["STEP 0: Query Clarify<br/>• queryClarifier<br/>• clarificationProcessor"]
  UQ --> SQ0
  SQ0 -->|Yes| Abort[/Ask user for details & abort/]
  SQ0 -->|No| AgentStart([ToT Deep Research Agent])

  subgraph ToT [ToT Deep Research Agent]
    direction TB
    P1["1) Planning Phase<br/>- thoughtGenerator → thoughts<br/>- thoughtEvaluator → evaluatedThoughts<br/>- pathSelector → selectedPath<br/><br/>【解説】<br/>• thoughtGenerator：多様な調査アプローチを自動生成<br/>• thoughtEvaluator：生成されたアプローチをスコア評価<br/>• pathSelector：最適な調査アプローチを選択"]
    P2["2) Information Gathering Phase<br/>- researchPlanGenerator → researchPlan<br/>- queryOptimizer → optimizedQueries<br/>- parallelSearchExecutor → collectedInformation<br/><br/>【解説】<br/>• researchPlanGenerator：詳細な調査計画を展開<br/>• queryOptimizer：検索クエリを最適化して高品質情報収集を支援<br/>• parallelSearchExecutor：複数検索を並列実行して情報を収集"]
    P3["3) Analysis Phase<br/>- informationEvaluator → evaluatedSources<br/>- hypothesisGenerator → hypotheses<br/>- gapAnalyzer → informationGaps<br/><br/>【解説】<br/>• informationEvaluator：収集情報の信頼性・関連性を評価<br/>• hypothesisGenerator：得られたデータから解釈仮説を生成<br/>• gapAnalyzer：調査結果の不足部分（情報ギャップ）を特定"]
    P4["4) Insight Generation Phase<br/>- insightGenerator → insights<br/>- storyBuilder → narrativeStructure<br/>- conclusionFormer → conclusions<br/><br/>【解説】<br/>• insightGenerator：重要な洞察を抽出・要約<br/>• storyBuilder：洞察を基にレポート全体の構成を設計<br/>• conclusionFormer：証拠に基づく結論を形成"]
    P5["5) Report Phase (Gen & Opt)<br/>- reportGenerator → rawReport<br/>- reportOptimizer → finalReport<br/><br/>【解説】<br/>• reportGenerator：統合洞察からレポート案を自動生成<br/>• reportOptimizer：レポートを読みやすく整形・最適化"]
    P6["OUTPUT<br/>• finalReport<br/>• reasoningSteps"]

    P1 --> P2 --> P3 --> P4 --> P5 --> P6
  end

  AgentStart --> P1 