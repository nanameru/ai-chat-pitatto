---
title: "Mastraでカスタムツールを作成・連携する方法"
emoji: "🛠️"
type: "article"
topics: ["mastra", "typescript", "ai", "agent", "workflow", "tool"]
published: false
---

---
title: "Mastraでカスタムツールを作成・連携する方法"
emoji: "🛠️"
type: "tech"
topics: ["mastra", "typescript", "ai", "agent", "workflow", "tool"]
published: false
---

# Mastraでカスタムツールを作成・連携する方法

Mastraフレームワークの強力な機能の一つに「ツール」があります。エージェントやワークフローは、これらのツールを使って外部APIを叩いたり、特定の計算処理を実行したり、ファイル操作を行ったりすることができます。Mastraには標準でいくつかのツールが用意されていますが、多くの場合、プロジェクト固有の処理を行うためのカスタムツールを作成する必要があります。

この記事では、Mastraで独自のカスタムツールを作成し、エージェントやワークフローから利用する方法をステップバイステップで解説します。

## カスタムツールとは？ なぜ必要？

Mastraにおけるツールとは、**エージェントやワークフローから呼び出し可能な、特定の機能を提供する関数のようなもの**です。

標準ツールだけではカバーできない、以下のような場合にカスタムツールが役立ちます。

-   社内APIや特定の外部サービスとの連携
-   独自のビジネスロジックや計算処理の実装
-   データベースアクセスやファイルシステム操作
-   特定のフォーマットでのデータ変換

カスタムツールを作成することで、Mastraアプリケーションの機能を自由に拡張できます。

## カスタムツールの作成方法: `createTool`

カスタムツールは、Mastra Coreが提供する `createTool` 関数を使って定義します。

```typescript
import { createTool } from '@mastra/core/tools';
import { z } from 'zod';

// 例：簡単な計算を行うカスタムツール
export const simpleCalculatorTool = createTool({
  // 1. ツールの識別子 (必須)
  id: 'simple-calculator',

  // 2. ツールの説明 (必須)
  // LLMがツールの機能を理解し、いつ使うべきか判断するために重要
  description: '二つの数値を受け取り、その合計、差、積、商を計算して返すツールです。',

  // 3. 入力スキーマ (必須)
  // zodを使って、ツールが受け取るデータの型と説明を定義
  inputSchema: z.object({
    number1: z.number().describe('計算する一つ目の数値'),
    number2: z.number().describe('計算する二つ目の数値'),
  }),

  // 4. 出力スキーマ (必須)
  // zodを使って、ツールが返すデータの型と説明を定義
  outputSchema: z.object({
    sum: z.number().describe('二つの数値の合計'),
    difference: z.number().describe('number1からnumber2を引いた差'),
    product: z.number().describe('二つの数値の積'),
    quotient: z.number().optional().describe('number1をnumber2で割った商 (ゼロ除算の場合はundefined)'),
  }),

  // 5. 実行ロジック (必須)
  // ツールが呼び出された際に実行される非同期関数
  execute: async ({ context }) => {
    // `context` オブジェクトから inputSchema で定義した入力値を取得
    const { number1, number2 } = context;

    console.log(`[simpleCalculatorTool] Executing with: ${number1}, ${number2}`);

    const sum = number1 + number2;
    const difference = number1 - number2;
    const product = number1 * number2;
    let quotient: number | undefined = undefined;

    // ゼロ除算を避ける
    if (number2 !== 0) {
      quotient = number1 / number2;
    } else {
      console.warn('[simpleCalculatorTool] Division by zero attempted.');
    }

    // outputSchema に従って結果を返す
    return {
      sum,
      difference,
      product,
      quotient,
    };
  },
});
```

### `createTool` の主要な引数

1.  **`id`**: ツールを一意に識別するための文字列です。ケバブケース（`kebab-case`）が推奨されます。
2.  **`description`**: このツールが何をするのかを自然言語で説明します。エージェントがツールを適切に選択・利用するために非常に重要です。具体的に、どのような入力で何が出力されるかを記述しましょう。
3.  **`inputSchema`**: `zod` を使って定義します。ツールが受け取るべきデータの構造、型、および各フィールドの説明 (`.describe()`) を指定します。
4.  **`outputSchema`**: `zod` を使って定義します。ツールが返すデータの構造、型、および各フィールドの説明 (`.describe()`) を指定します。
5.  **`execute`**: ツールの中核となる非同期関数です。引数として `{ context }` オブジェクトを受け取ります。`context` には `inputSchema` で定義された入力データが含まれています。この関数内で主要な処理を行い、`outputSchema` に適合するオブジェクトを `return` します。

## カスタムツールの利用

作成したカスタムツールは、エージェントやワークフローから利用できます。

### エージェントでの利用

エージェントを定義する際に `tools` プロパティに作成したツールインスタンスを渡します。

```typescript
import { Agent } from '@mastra/core/agent';
import { openai } from '@ai-sdk/openai';
import { simpleCalculatorTool } from './tools/calculatorTool'; // 作成したツールをインポート

export const calculatorAgent = new Agent({
  name: 'calculator-agent',
  instructions: 'ユーザーから二つの数値を受け取り、計算結果を返してください。計算には利用可能なツールを使用してください。',
  model: openai('gpt-4o'),
  // tools プロパティにツールを登録
  tools: {
    simpleCalculatorTool,
    // 他のツールもここに追加可能
  },
});

// エージェントの実行例
async function runAgent() {
  const result = await calculatorAgent.run({
    input: '5と3を計算して',
  });
  console.log(result);
}

runAgent();
```

エージェントは、ユーザーの指示とツールの `description` をもとに、適切なタイミングで `simpleCalculatorTool` を呼び出し、その結果を使って応答を生成します。

### ワークフローでの利用

ワークフローのステップ内でツールを呼び出すには、`execute` 関数内で `context.tools.<toolId>()` のように呼び出します。

```typescript
import { Workflow, Step } from '@mastra/core/workflows';
import { z } from 'zod';
import { mastra } from '../index';
// calculatorTool は simpleCalculatorTool を含むように index.ts などでエクスポートされている想定
import { calculatorTool } from './tools';

export const calculationWorkflow = new Workflow({
  name: 'calculation-workflow',
  triggerSchema: z.object({
    a: z.number(),
    b: z.number(),
  }),
  mastra,
  // Workflow レベルで利用するツールを登録
  tools: [calculatorTool.simpleCalculatorTool],
});

const calculateStep = new Step({
  id: 'perform-calculation',
  inputSchema: z.object({
    num1: z.number(),
    num2: z.number(),
  }),
  outputSchema: calculatorTool.simpleCalculatorTool.outputSchema, // ツールの出力スキーマを再利用
  execute: async ({ context, tools }) => {
    console.log(`[calculateStep] Calling simpleCalculatorTool with ${context.input.num1}, ${context.input.num2}`);

    // context.tools 経由でツールを呼び出す
    const calculationResult = await tools.simpleCalculatorTool({
      number1: context.input.num1,
      number2: context.input.num2,
    });

    console.log('[calculateStep] Calculation result:', calculationResult);
    return calculationResult;
  },
});

calculationWorkflow
  .step(calculateStep, {
    mapInput: (ctx) => ({ num1: ctx.triggerData.a, num2: ctx.triggerData.b }),
  })
  .commit();

// ワークフローの実行例
async function runWorkflow() {
  const run = await mastra.run({
    workflowName: calculationWorkflow.name,
    triggerData: { a: 10, b: 5 },
  });
  const output = await run.output();
  console.log('Workflow output:', output);
}

runWorkflow();
```

ワークフロー内でツールを利用する場合：

1.  `Workflow` のコンストラクタで `tools` プロパティに利用したいツールインスタンスの配列を渡します。
2.  `Step` の `execute` 関数の引数に `tools` オブジェクトが追加で渡されます。
3.  `tools.<toolId>(...)` の形式で、`inputSchema` に適合するデータを渡してツールを呼び出します。
4.  ツールの実行結果（`outputSchema` に適合するデータ）が返されます。

## ベストプラクティス

-   **明確な `description`**: エージェントがツールを正しく理解し利用できるように、具体的で分かりやすい説明を記述します。
-   **厳密なスキーマ定義**: `zod` を使って入力と出力を厳密に定義し、予期せぬエラーを防ぎます。`.describe()` で各フィールドの説明も加えましょう。
-   **単一責任の原則**: ツールは一つの明確な責務を持つように設計します。複雑な処理は複数のツールに分割するか、サブワークフローの利用を検討します。
-   **エラーハンドリング**: `execute` 関数内で発生しうるエラー（APIエラー、不正な入力など）を適切に処理し、必要に応じてエラー情報を返すか、例外をスローします。
-   **整理された配置**: ツールが増えてきたら、`src/mastra/tools/` ディレクトリ内に機能ごとにファイルを分割して整理しましょう。

## まとめ

Mastraのカスタムツールは、アプリケーションの機能を拡張するための必須要素です。`createTool` 関数と `zod` スキーマを組み合わせることで、型安全で再利用可能なツールを簡単に作成できます。

明確な説明と厳密なスキーマ定義を心がけ、エージェントやワークフローからカスタムツールを効果的に連携させることで、より高度で柔軟なAIアプリケーションを構築しましょう。
